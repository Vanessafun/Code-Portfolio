---
title: "BDA A1"
author: "Wenyi Fang"
output:
  pdf_document: default
  html_document: default
---


#Data and packages
```{r}
setwd("/Users/vanessafung/Desktop")
library(tinytex)
library(tidyverse)
library(tibble)
library(dplyr)
library(tidyr)
library(magrittr)
library(purrr)
library(ggplot2)
library(R6)
library(data.table)
library(caret)
library(lmtest)
f1 = read.csv(file = "assignment1_data/cohort.csv")
f2 = read.csv(file = "assignment1_data/lab1.csv")
linker = read.csv(file = "assignment1_data/linker.csv")
ltegfr1 = read.csv(file = "assignment1_data/ltegfr1.csv")
ltegfr2 = read.csv(file = "assignment1_data/ltegfr2.csv")
scr2 = read.csv(file = "assignment1_data/scr2.csv")
infert = data(infert)
```

#Problem 1
##(a)merge file1 and linker to add "LABID" column for file1,then use "LABID" to merge file1 and file2，factor order may have some misunderstanding
```{r}
cohort.dt = merge(merge(f1,linker,by.x = "id"),f2)

#assertion
stopifnot(cohort.dt$"id" %in% linker$"id") 
stopifnot(cohort.dt$"LABID" %in% linker$"LABID")
#delete "LABID"
cohort.dt<-cohort.dt[,-2]
cohort.dt$diabetes = as.factor(cohort.dt$diabetes)

#
cohort.dt$albumin<-factor(cohort.dt$albumin,levels = c("normo","micro","macro"),labels =c("normo","micro","macro"))
```

##（b)impute missing age based on year of birth 
```{r}
cohort.dt$age[is.na =T]<-2019-round(cohort.dt$yob)
```

##(c)define three function to calculate median(IQR),total N, missing N, then apply those function to every column.
```{r}
#define two functions to count total number and NA number
count.na.num<-function(x){
  return(sum(is.na(x)))
}
count.num<-function(x){
  return(sum(!is.na(x)))
}
#define the median calculation function
median.or.percent <- function(x,impute.to.mean = FALSE){
  if (impute.to.mean) {
    x<- ifelse(is.na(x)==TRUE, mean(x, na.rm = TRUE), x = x)
  }
      
  if (is.numeric(x)||is.integer(x)){
    x = na.omit(x)
    x.median = median(x)
    IQR1 = quantile(x,0.25,na.rm = T)
    IQR2 = quantile(x,0.75,na.rm = T)
    return(cat(x.median,"(",IQR1,",",IQR2,")"))
  }else {
    return(1-count.na.num(x)/sum(!is.na(x)))
  }
}

#calculate median, total N and missing N for each column in cohort.dt
median.summary <- apply(cohort.dt[-2], 2, median.or.percent)
median.summary  = as.character(median.summary)
total.n.summary <- apply(cohort.dt[-2], 2, count.num)

missing.n.summary <- apply(cohort.dt[-2], 2, count.na.num)
#define a character vector to name column in sumaary table
summary.row.names <- c("variable_name", "median", "total N", "missing N")
#form the final summary table
summary_table <-
  data.frame(median.summary, total.n.summary, missing.n.summary)
summary_table
```

##(d)
```{r}

```

#Problem 2
##(a)Convert the files to data tables and merge them by id
```{r}
ltegfr2<-as_tibble(ltegfr2)%>%
  rename(id = ID)
ltegfr<-merge(ltegfr1,ltegfr2,all.x = TRUE)
ltegfr[
  order( ltegfr[,1], ltegfr[,2] ),
]%>%as.data.table()

#assertion
stopifnot(ltegfr$id == sort(ltegfr$id))
for (i in 250){
  stopifnot(ltegfr$egfr[ltegfr$id==i]==sort(ltegfr$egfr[ltegfr$id==i]))
}
```

##(b)ranged.egfr.table is the average egfr ranged table,and the number of patients with missing average eGFR is 39.patients have a slope < -3, [-3, 0), [0, 3], > 3 are 153,31,24,70 separately
```{r}
#calculate each patients mean and length 
ltegfr = na.omit(ltegfr)
ltegfr<-as_tibble(ltegfr)%>%
  group_by(id)%>%mutate(mean(egfr))%>% mutate(length(fu.years))%>%
  rename("mean.egfr" = "mean(egfr)","len.fuyears"= "length(fu.years)")

#count numbers in each range and form a table
egfr.value<-unique(ltegfr$mean.egfr)
missing.id<-unique(ltegfr$id[is.na(ltegfr$mean.egfr)])
count.num(missing.id)
egfr.range<-c("(0,15]","(15,30]","(30,60]","(60,90]","(90,Inf)")
range.number <-
  c(
    sum(egfr.value > 0 &
          egfr.value <= 15, na.rm = T),
    sum(egfr.value > 15 &
          egfr.value <= 30, na.rm = T),
    sum(egfr.value > 30 &
          egfr.value <= 60, na.rm = T),
    sum(egfr.value > 60 &
          egfr.value <= 90, na.rm = T),
    sum(egfr.value > 90, na.rm = T)
  )
ranged.egfr.table<-data.frame(egfr.range,range.number)

#fitting a lm for each patients with >3 average egfr
fit.table<-data.frame()
completedt.with.3more = na.omit(ltegfr)%>%group_by(id)%>%count()
completedt.with.3more = completedt.with.3more[completedt.with.3more$n>3,]
for (i in completedt.with.3more$id){
  fit.i<-lm(egfr~fu.years,data = ltegfr[ltegfr$id == i,])
  summary.i<-summary(fit.i)
  fit.table<-rbind(fit.table,c(summary.i$coefficients[2,c(1,4)]))
}
#numbers of slope in different range are 153,31,24,70 separately
slope = fit.table[,1]
sum(slope<3)
sum(slope>=-3&slope<0)
sum(slope>=0&slope<3)
sum(slope>3)
```

##(c) dyplr is used to select observations and sum up
```{r}
patient.0.15.megfr<-ltegfr[ltegfr$mean.egfr<=15,]
patient.0.15.megfr = as_tibble(patient.0.15.megfr)%>%na.omit()%>%group_by(id)%>%
  summarise(baseline.age = unique(baseline.age),
            ave.egfr = mean(egfr),
            last.read = max(fu.years),
            num.egfr = n(),
            sex = unique(sex)
            )
patient.0.15.megfr
```

##(d)patient 3,37,162 and 223 are analysised and result are show in plots
```{r}
#For patient 3
patient3 = ltegfr[ltegfr$id==3,]
#draw a plot to decribe patient’s eGFR measurements as a function of time
plot1 = egfr.vs.time = qplot(fu.years,egfr,data = patient3,xlab = "time",ylab = "eGFR",main = "patient’s eGFR measurements as a function of time")+
  geom_smooth(method = lm,colour = "black")
egfr.vs.time

#linear model for patient3
p3.fit = lm(egfr~fu.years,data = patient3)
p3.confint = confint(p3.fit,"fu.years")
p3.confint

#omit extreme value case
patient3.omit = patient3[patient3$egfr != max(patient3$egfr)&patient3$egfr != min(patient3$egfr),]
p3.fit.outlomit<-lm(egfr~fu.years,data = patient3.omit)
plot1+
  geom_smooth(method = lm,data = patient3.omit,colour = "red")

#for patient 37
patient37 = ltegfr[ltegfr$id==37,]
#draw a plot to decribe patient’s eGFR measurements as a function of time
plot2 = qplot(fu.years,egfr,data = patient37,xlab = "time",ylab = "eGFR",main = "patient’s eGFR measurements as a function of time")+
  geom_smooth(method = lm,colour = "black")
plot2
#linear model for patient37
p37.fit = lm(egfr~fu.years,data = patient37)
p37.confint = confint(p37.fit,"fu.years")
p37.confint

#omit extreme value case
patient37.omit = patient37[patient37$egfr != max(patient37$egfr)&patient37$egfr != min(patient37$egfr),]
p37.fit.outlomit<-lm(egfr~fu.years,data = patient37.omit)
plot1+
  geom_smooth(method = lm,data = patient37.omit,colour = "red")

#for patient 162
patient162 = ltegfr[ltegfr$id==162,]
#draw a plot to decribe patient’s eGFR measurements as a function of time
plot1 = egfr.vs.time = qplot(fu.years,egfr,data = patient162,xlab = "time",ylab = "eGFR",main = "patient’s eGFR measurements as a function of time")+
  geom_smooth(method = lm,colour = "black")
egfr.vs.time

#linear model for patient162
p162.fit = lm(egfr~fu.years,data = patient162)
p162.confint = confint(p162.fit,"fu.years")
p162.confint

#omit extreme value case
patient162.omit = patient162[patient162$egfr != max(patient162$egfr)&patient162$egfr != min(patient162$egfr),]
p162.fit.outlomit<-lm(egfr~fu.years,data = patient162.omit)
plot1+
  geom_smooth(method = lm,data = patient162.omit,colour = "red")

#for patient 223
patient223 = ltegfr[ltegfr$id==223,]
#draw a plot to decribe patient’s eGFR measurements as a function of time
plot1 = egfr.vs.time = qplot(fu.years,egfr,data = patient223,xlab = "time",ylab = "eGFR",main = "patient’s eGFR measurements as a function of time")+
  geom_smooth(method = lm,colour = "black")
egfr.vs.time

#linear model for patient223
p223.fit = lm(egfr~fu.years,data = patient223)
p223.confint = confint(p223.fit,"fu.years")
p223.confint

#omit extreme value case
patient223.omit = patient223[patient223$egfr != max(patient223$egfr)&patient223$egfr != min(patient223$egfr),]
p223.fit.outlomit<-lm(egfr~fu.years,data = patient223.omit)
plot1+
  geom_smooth(method = lm,data = patient223.omit,colour = "red")

```


###Problem 3 
##(a)define a R6 class named Calcegfr
```{r}
Calcegfr<-R6Class(classname = "Calcegfr",
  public = list(
    scr=numeric(),
    age=integer(),
    sex=factor(),
    ethnicity=factor(),
    initialize=function(scr,age,sex,ethnicity){
     self$scr =scr
     self$age =age
     self$sex = sex
     self$ethnicity = ethnicity
  },
    egfr.mdrd4 = function() {
      scr = self$scr
      age = self$age
      sex = self$sex
      ethnicity = self$ethnicity
      if (sex == "Female"){
        if (ethnicity == "Black"){
          mdrd=175*(scr/88.42)^(-1.154)*age^(-0.203)*1.212*0.742
         } else {
          mdrd=175*(scr/88.42)^(-1.154)*age^(-0.203)*0.742
        }
      } else {
         if (ethnicity == "Black"){
        mdrd=175*(scr/88.42)^(-1.154)*age^(-0.203)*1.212
         }else{
         mdrd=175*(scr/88.42)^(-1.154)*age^(-0.203)
      }
      }
      mdrd
     },
    egfr.ckdepi = function() {
      scr = self$scr
      age = self$age
      sex = self$sex
      ethnicity = self$ethnicity 
      if(sex == "Female"){
        if(ethnicity == "Black"){
          ckdepi=141*(min((scr/88.42)/0.7,1)^(-0.329))*(max((scr/88.42)/0.7,1)^(-1.209))*(0.993^age)*1.018*1.159
        } else {
          ckdepi=141*(min((scr/88.42)/0.7,1)^(-0.329))*(max((scr/88.42)/0.7,1)^(-1.209))*(0.993^age)*1.018
        }
      }else {
        if (ethnicity == "Black"){
          ckdepi=141*(min((scr/88.42)/0.9,1)^(-0.411))*(max((scr/88.42)/0.9,1)^(-1.209))*(0.993^age)*1.159
        }else {
          ckdepi=141*(min((scr/88.42)/0.9,1)^(-0.411))*(max((scr/88.42)/0.9,1)^(-1.209))*(0.993^age)
        }
      }
      ckdepi
     }
 )
)
```

##(b)mdrd4 mean and sd are 48.94 and 39.19, ckdepi mean and sd are 0.42 and 0.05,their Pearson correlation coefficient is 0.46
```{r}
scr2 = na.omit(scr2)
egfr2 = Calcegfr$new(scr2$scr,scr2$age,scr2$sex,scr2$ethnic)

mdrd4 = egfr2$egfr.mdrd4()
ckdepi = egfr2$egfr.ckdepi()
m.mdrd4 = round(mean(mdrd4),2)#48.94
sd.mdrd4 = round(sd(mdrd4),2)#39.19
m.ckdepi = round(mean(ckdepi),2)# 0.42
sd.ckdepi = round(sd(ckdepi),2)#0.05
cor(mdrd4,ckdepi,method = "pearson")#0.4617177
```

##(c)scatter plots of mdrd4 va ckedpi, there'a linear relationship since ckdepi have a significant coefficient in the simple linear model Mtest.
```{r}
ggplot(aes = c(mdrd4,ckdepi))+
  geom_point(aes(x = mdrd4,y = ckdepi))+
  geom_vline(xintercept = c(median(mdrd4),quantile(mdrd4,c(0.25,0.75))),colour = c("blue","red","green") )+
  geom_hline(yintercept = c(median(ckdepi),quantile(ckdepi,c(0.25,0.75))),colour = c("blue","red","green") )

Mtest<-lm(mdrd4~ckdepi)
summary(Mtest)
```

###Problem4
##(a)M1 residual deviance is 316.17, p-values of intercept,age and parity are 0.367,0.965,0.892 separately.
```{r}
data("infert")
infert = as.data.table(infert)
M1 <- glm(case ~ age + parity, data = infert, family = "binomial")
summary(M1)

```

##(b)The odds ratio of spontaneous is 3.45 and its corresponding 95%confidence interval is (2.27 5.39)，the p-value of likelihood ratio test is 1.348e-09 ,which means M2 includes spontaneous is a better fit.
```{r}
M2<-glm(case ~ age + parity+spontaneous, data = infert, family = "binomial")
cat("The odds ratio of spontaneous is",round(exp(M2$coefficients[4]),2))
cat("The 95% confidence interval is",ci.95 = round(exp(confint(M2, 'spontaneous', level=0.95)),2))

lrtest(M1, M2)
```

##(c)the devaince is 613.0216 the null deiviance is 181.4305
```{r}
y.pred = M2$fitted.values
#define the loglik.binom() to compute deviance and null deviance
loglik.binom <- function(y.obs, y.pred){
  case.indicator<-ifelse(y.obs == 1,1,0)
  sum(log(y.pred[case.indicator == 1]))+sum(log(y.pred[case.indicator==0]))
}
#calculate deviance and null deviance
loglik.bi<-loglik.binom(infert$case,y.pred = y.pred)
y.mean<-mean(as.numeric(infert$case))
deviance<-(-2)*loglik.bi
null.deviance<-(-2)*length(infert$case)*y.mean*log(y.mean)+(1-y.mean)*log(1-y.mean)
cat("the devaince is",deviance,"the null deiviance is",null.deviance)

```

##(d)10-fold cv is carried out and some quantities are calculated
```{r}
glm.cv<- function(formula, data, folds) {
  regr.cv <- NULL
  for (fold in 1:length(folds)) {
    regr.cv[[fold]] <- glm(formula, data=data[-folds[[fold]], ], family="binomial")
  }
  return(regr.cv) 
}

#10-fold cv
set.seed(1)
folds <- createFolds(infert$case, k=10)
cv.m2 <- glm.cv(case ~ age + parity+spontaneous, infert, folds)

predict.cv <- function(regr.cv, data, outcome, folds) {
  pred.cv <- NULL
  for (fold in 1:length(folds)) {
    test.idx <- folds[[fold]]
    pred.cv[[fold]] <- data.frame(obs=outcome[test.idx], pred=predict(regr.cv[[fold]], newdata=data,
                                                                      type="response")[test.idx])
  }
  return(pred.cv) 
  }
pred.cv.m2 <- predict.cv(cv.m2, infert, infert$case, folds) 
loglik.cv.m2 <- numeric(length(folds))

```

